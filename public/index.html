<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionnaire de Bot WhatsApp</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin-top: 30px;
        }

        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .card-header {
            background-color: #25d366;
            color: white;
            border-radius: 10px 10px 0 0 !important;
        }

        .btn-whatsapp {
            background-color: #25d366;
            color: white;
        }

        .btn-whatsapp:hover {
            background-color: #128c7e;
            color: white;
        }

        .preview-image {
            max-width: 100px;
            max-height: 100px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .image-container {
            display: flex;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .qr-container {
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        #qrcode img {
            margin: 0 auto;
        }

        .status-badge {
            font-size: 14px;
            padding: 5px 10px;
        }

        .image-item {
            position: relative;
            margin: 5px;
        }

        .remove-img {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ff4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        #messagePreview {
            white-space: pre-line;
            background-color: #dcf8c6;
            border-radius: 10px;
            padding: 10px;
            margin-top: 10px;
            font-family: Arial, sans-serif;
        }

        .tab-content {
            padding: 20px;
        }
        
        /* New styles for videos and audio */
        .video-container, .audio-container {
            display: flex;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .video-item, .audio-item {
            position: relative;
            margin: 5px;
            width: 200px;
        }

        .video-preview {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .audio-preview {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .media-title {
            font-size: 12px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-top: 5px;
        }

        .media-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
        }

        .media-controls button {
            padding: 2px 5px;
            font-size: 12px;
        }

        .play-preview {
            display: block;
            width: 100%;
            margin-top: 5px;
        }
        
        /* Product Management Styles */
        .product-container {
            margin-top: 20px;
        }
        
        .product-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            transition: transform 0.2s;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .product-header {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            background-color: #f8f9fa;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .product-body {
            padding: 15px;
        }
        
        .product-footer {
            padding: 10px 15px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .product-attribute {
            display: flex;
            margin-bottom: 5px;
        }
        
        .attribute-key {
            font-weight: bold;
            width: 100px;
            flex-shrink: 0;
        }
        
        .attribute-value {
            flex-grow: 1;
        }
        
        .category-badge {
            background-color: #e9ecef;
            color: #495057;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 12px;
        }
        
        .in-stock {
            color: #198754;
        }
        
        .out-of-stock {
            color: #dc3545;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="text-center mb-4">
            <i class="fab fa-whatsapp text-success"></i> Gestionnaire de Bot WhatsApp
        </h1>

        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-plug"></i> État de la connexion</h5>
                    </div>
                    <div class="card-body text-center">
                        <div class="mb-3">
                            <span id="connectionStatus" class="badge bg-warning status-badge">Non connecté</span>
                        </div>
                        <div id="qrContainer" class="qr-container">
                            <div id="qrcode"></div>
                        </div>
                        <p id="qrHelp">Scannez le code QR avec votre application WhatsApp pour vous connecter.</p>
                        <button id="refreshQr" class="btn btn-whatsapp"><i class="fas fa-sync-alt"></i> Actualiser le
                            QR</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-line"></i> Statistiques</h5>
                    </div>
                    <div class="card-body">
                        <p><i class="fas fa-users"></i> Clients: <span id="clientCount">0</span></p>
                        <p><i class="fas fa-comment-dots"></i> Messages envoyés: <span id="messageCount">0</span></p>
                        <p><i class="fas fa-clock"></i> En service depuis: <span id="uptime">0 minutes</span></p>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="myTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="welcome-tab" data-bs-toggle="tab"
                                    data-bs-target="#welcome" type="button" role="tab" aria-controls="welcome"
                                    aria-selected="true">
                                    Message d'accueil
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="images-tab" data-bs-toggle="tab" data-bs-target="#images"
                                    type="button" role="tab" aria-controls="images" aria-selected="false">
                                    Images
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="videos-tab" data-bs-toggle="tab" data-bs-target="#videos"
                                    type="button" role="tab" aria-controls="videos" aria-selected="false">
                                    Vidéos
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="audio-tab" data-bs-toggle="tab" data-bs-target="#audio"
                                    type="button" role="tab" aria-controls="audio" aria-selected="false">
                                    Audio
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="products-tab" data-bs-toggle="tab" data-bs-target="#products"
                                    type="button" role="tab" aria-controls="products" aria-selected="false">
                                    Produits
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="clients-tab" data-bs-toggle="tab" data-bs-target="#clients"
                                    type="button" role="tab" aria-controls="clients" aria-selected="false">
                                    Clients
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="settings-tab" data-bs-toggle="tab"
                                    data-bs-target="#settings" type="button" role="tab" aria-controls="settings"
                                    aria-selected="false">
                                    Paramètres
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="ai-agent-tab" data-bs-toggle="tab" data-bs-target="#ai-agent"
                                    type="button" role="tab" aria-controls="ai-agent" aria-selected="false">
                                    AI Agent
                                </button>
                            </li>
                        </ul>
                    </div>
                    <div class="tab-content" id="myTabContent">
                        <div class="tab-pane fade show active" id="welcome" role="tabpanel"
                            aria-labelledby="welcome-tab">
                            <h5>Message d'accueil automatique</h5>
                            <div class="mb-3">
                                <textarea id="welcomeMessage" class="form-control" rows="6"></textarea>
                            </div>
                            <div class="d-flex justify-content-between">
                                <button id="previewMessage" class="btn btn-secondary">
                                    <i class="fas fa-eye"></i> Aperçu
                                </button>
                                <button id="saveMessage" class="btn btn-whatsapp">
                                    <i class="fas fa-save"></i> Enregistrer
                                </button>
                            </div>
                            <div id="messagePreview" class="mt-3 d-none"></div>
                        </div>
                        <div class="tab-pane fade" id="images" role="tabpanel" aria-labelledby="images-tab">
                            <h5>Images d'accueil</h5>
                            <p>Ces images seront envoyées automatiquement avec le message d'accueil.</p>

                            <div class="mb-3">
                                <label for="imageUpload" class="form-label">Ajouter de nouvelles images</label>
                                <input class="form-control" type="file" id="imageUpload" accept="image/*" multiple>
                            </div>

                            <h6>Images actuelles:</h6>
                            <div id="currentImages" class="image-container">
                                <!-- Les images seront ajoutées ici par JavaScript -->
                            </div>
                        </div>
                        <div class="tab-pane fade" id="videos" role="tabpanel" aria-labelledby="videos-tab">
                            <h5>Vidéos d'accueil</h5>
                            <p>Ces vidéos seront envoyées automatiquement avec le message d'accueil.</p>

                            <div class="mb-3">
                                <label for="videoUpload" class="form-label">Ajouter de nouvelles vidéos</label>
                                <input class="form-control" type="file" id="videoUpload" accept="video/*" multiple>
                            </div>

                            <h6>Vidéos actuelles:</h6>
                            <div id="currentVideos" class="video-container">
                                <!-- Les vidéos seront ajoutées ici par JavaScript -->
                            </div>
                        </div>
                        <div class="tab-pane fade" id="audio" role="tabpanel" aria-labelledby="audio-tab">
                            <h5>Fichiers audio d'accueil</h5>
                            <p>Ces fichiers audio seront envoyés automatiquement avec le message d'accueil.</p>

                            <div class="mb-3">
                                <label for="audioUpload" class="form-label">Ajouter de nouveaux fichiers audio</label>
                                <input class="form-control" type="file" id="audioUpload" accept="audio/*" multiple>
                            </div>

                            <h6>Fichiers audio actuels:</h6>
                            <div id="currentAudio" class="audio-container">
                                <!-- Les fichiers audio seront ajoutés ici par JavaScript -->
                            </div>
                        </div>
                        
                        <!-- New Products Tab -->
                        <div class="tab-pane fade" id="products" role="tabpanel" aria-labelledby="products-tab">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5>Gestion des Produits</h5>
                                <div>
                                    <button id="refreshAIData" class="btn btn-info me-2">
                                        <i class="fas fa-robot"></i> Rafraîchir l'IA
                                    </button>
                                    <button id="addProductBtn" class="btn btn-whatsapp">
                                        <i class="fas fa-plus"></i> Ajouter un Produit
                                    </button>
                                </div>
                            </div>
                            
                            <p>Gérez les produits qui seront recommandés par l'assistant IA dans les conversations WhatsApp.</p>
                            
                            <div class="mb-3">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" id="productSearch" class="form-control" placeholder="Rechercher un produit...">
                                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        Catégorie
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end" id="categoryFilter">
                                        <li><a class="dropdown-item active" href="#" data-category="all">Toutes les catégories</a></li>
                                        <!-- Categories will be added here dynamically -->
                                    </ul>
                                </div>
                            </div>
                            
                            <div id="productsList" class="product-container">
                                <!-- Products will be loaded here -->
                                <div class="text-center py-5">
                                    <div class="spinner-border text-success" role="status">
                                        <span class="visually-hidden">Chargement...</span>
                                    </div>
                                    <p class="mt-2">Chargement des produits...</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="clients" role="tabpanel" aria-labelledby="clients-tab">
                            <h5>Liste des clients</h5>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Numéro</th>
                                            <th>Nom</th>
                                            <th>Premier contact</th>
                                            <th>Dernier contact</th>
                                            <th>Messages</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="clientsTable">
                                        <!-- Les clients seront ajoutés ici par JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
                            <h5>Paramètres du bot</h5>
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enableAutoReply" checked>
                                    <label class="form-check-label" for="enableAutoReply">Activer les réponses
                                        automatiques</label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enableAI" checked>
                                    <label class="form-check-label" for="enableAI">Activer l'intelligence artificielle</label>
                                </div>
                                <small class="text-muted">L'IA analysera les questions des clients et fournira des réponses personnalisées sur vos produits.</small>
                            </div>
                            <div class="mb-3">
                                <label for="delayInput" class="form-label">Délai entre les messages (secondes)</label>
                                <input type="number" class="form-control" id="delayInput" min="1" value="2">
                            </div>
                            <button id="saveSettings" class="btn btn-whatsapp">
                                <i class="fas fa-save"></i> Enregistrer les paramètres
                            </button>
                        </div>
                        <div class="tab-pane fade" id="ai-agent" role="tabpanel" aria-labelledby="ai-agent-tab">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5>AI Agent</h5>
                                <div id="aiAgentButtons">
                                    <button id="editAIContext" class="btn btn-primary">
                                        <i class="fas fa-edit"></i> Modifier
                                    </button>
                                    <button id="saveAIContext" class="btn btn-whatsapp d-none">
                                        <i class="fas fa-save"></i> Enregistrer
                                    </button>
                                    <button id="cancelAIContext" class="btn btn-secondary d-none">
                                        <i class="fas fa-times"></i> Annuler
                                    </button>
                                </div>
                            </div>
                            
                            <p class="mb-4">Entrez des informations détaillées sur vos produits. L'IA utilisera ces informations pour répondre aux questions des clients.</p>
                            
                            <div id="statusMessage" class="alert d-none"></div>
                            
                            <div class="mb-4">
                                <label for="aiContextName" class="form-label">Nom de la base de connaissances</label>
                                <input type="text" class="form-control" id="aiContextName" value="Informations sur les produits" disabled>
                            </div>
                        
                            <div class="mb-4">
                                <label for="aiContext" class="form-label">Informations sur les produits</label>
                                <textarea class="form-control" id="aiContext" rows="12" disabled
                                    placeholder="Entrez des informations détaillées sur vos produits ici. Incluez les caractéristiques, avantages, prix, et autres détails pertinents."></textarea>
                            </div>
                        
                            <hr class="my-4">
                        
                            <div>
                                <h5 class="mb-3">Tester la réponse de l'IA</h5>
                                <p class="mb-3">Posez une question à l'IA pour voir comment elle répondrait en utilisant les informations ci-dessus.</p>
                        
                                <div class="mb-3">
                                    <label for="testQuestion" class="form-label">Votre question</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="testQuestion" 
                                            placeholder="Posez une question sur vos produits...">
                                        <button class="btn btn-success" id="testAIButton">
                                            <i class="fas fa-robot"></i> Tester
                                        </button>
                                    </div>
                                </div>
                        
                                <div id="testResponseContainer" class="mb-4 d-none">
                                    <label class="form-label">Réponse de l'IA</label>
                                    <div id="testResponse" class="p-3 bg-light rounded border"></div>
                                </div>
                        
                                <div id="testHistoryContainer" class="d-none">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6>Historique des tests récents</h6>
                                        <button id="clearTestHistory" class="btn btn-sm btn-outline-danger">
                                            <i class="fas fa-trash"></i> Effacer l'historique
                                        </button>
                                    </div>
                                    
                                    <div id="testHistory" class="border rounded">
                                        <!-- History items will be added here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Product Form Modal -->
    <div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalLabel">Ajouter un Produit</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="productCode" class="form-label">Code Produit</label>
                            <input type="text" class="form-control" id="productCode" required>
                        </div>
                        <div class="col-md-6">
                            <label for="productName" class="form-label">Nom Produit</label>
                            <input type="text" class="form-control" id="productName" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="productCategory" class="form-label">Catégorie</label>
                            <select class="form-select" id="productCategory">
                                <option value="">Sélectionner une catégorie</option>
                                <!-- Categories will be loaded here -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="productPrice" class="form-label">Prix (MAD)</label>
                            <input type="number" class="form-control" id="productPrice" min="0" step="0.01">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check form-switch mt-4">
                                <input class="form-check-input" type="checkbox" id="productInStock" checked>
                                <label class="form-check-label" for="productInStock">En stock</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="productQuantity" class="form-label">Quantité en stock</label>
                            <input type="number" class="form-control" id="productQuantity" min="0">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="productDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="productDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="productImages" class="form-label">Images du Produit</label>
                        <input class="form-control" type="file" id="productImages" accept="image/*" multiple>
                        <div id="productImagesPreview" class="mt-2 image-container">
                            <!-- Image previews will be shown here -->
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <label class="form-label">Attributs du Produit</label>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="addAttributeBtn">
                                <i class="fas fa-plus"></i> Ajouter un Attribut
                            </button>
                        </div>
                        <div id="productAttributes" class="mt-2">
                            <!-- Attributes will be added here -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-whatsapp" id="saveProductBtn">Enregistrer</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode.js@1.0.0/qrcode.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Charger le message d'accueil depuis le serveur
            fetch('/api/settings/welcome-message')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('welcomeMessage').value = data.message || '';
                })
                .catch(error => console.error('Erreur lors du chargement du message:', error));

            // Charger les statistiques
            function loadStats() {
                fetch('/api/stats')
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('clientCount').textContent = data.clientCount || 0;
                        document.getElementById('messageCount').textContent = data.messageCount || 0;
                        document.getElementById('uptime').textContent = data.uptime || '0 minutes';
                    })
                    .catch(error => console.error('Erreur lors du chargement des statistiques:', error));
            }

            // Charger les images actuelles
            function loadImages() {
                fetch('/api/settings/welcome-images')
                    .then(response => response.json())
                    .then(data => {
                        const container = document.getElementById('currentImages');
                        container.innerHTML = '';

                        if (data.images && data.images.length > 0) {
                            data.images.forEach(image => {
                                const imgDiv = document.createElement('div');
                                imgDiv.className = 'image-item';

                                const img = document.createElement('img');
                                img.src = `/media/images/${image}`;
                                img.className = 'preview-image';
                                img.alt = image;

                                const removeBtn = document.createElement('div');
                                removeBtn.className = 'remove-img';
                                removeBtn.innerHTML = '×';
                                removeBtn.onclick = function () {
                                    deleteMedia('images', image);
                                };

                                imgDiv.appendChild(img);
                                imgDiv.appendChild(removeBtn);
                                container.appendChild(imgDiv);
                            });
                        } else {
                            container.innerHTML = '<p>Aucune image disponible.</p>';
                        }
                    })
                    .catch(error => console.error('Erreur lors du chargement des images:', error));
            }

            // Function to load videos
            function loadVideos() {
                fetch('/api/settings/welcome-videos')
                    .then(response => response.json())
                    .then(data => {
                        const container = document.getElementById('currentVideos');
                        container.innerHTML = '';

                        if (data.videos && data.videos.length > 0) {
                            data.videos.forEach(video => {
                                const videoDiv = document.createElement('div');
                                videoDiv.className = 'video-item';

                                // Create video preview
                                const videoPreview = document.createElement('video');
                                videoPreview.className = 'video-preview';
                                videoPreview.src = `/media/videos/${video}`;
                                videoPreview.setAttribute('controlsList', 'nodownload');
                                
                                // Create title
                                const title = document.createElement('div');
                                title.className = 'media-title';
                                title.textContent = video;
                                
                                // Create controls
                                const controls = document.createElement('div');
                                controls.className = 'media-controls';
                                
                                // Play button
                                const playBtn = document.createElement('button');
                                playBtn.className = 'btn btn-sm btn-primary';
                                playBtn.innerHTML = '<i class="fas fa-play"></i>';
                                playBtn.onclick = function() {
                                    videoPreview.controls = true;
                                    videoPreview.play();
                                };
                                
                                // Delete button
                                const deleteBtn = document.createElement('button');
                                deleteBtn.className = 'btn btn-sm btn-danger';
                                deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                                deleteBtn.onclick = function() {
                                    deleteMedia('videos', video);
                                };
                                
                                controls.appendChild(playBtn);
                                controls.appendChild(deleteBtn);
                                
                                videoDiv.appendChild(videoPreview);
                                videoDiv.appendChild(title);
                                videoDiv.appendChild(controls);
                                container.appendChild(videoDiv);
                            });
                        } else {
                            container.innerHTML = '<p>Aucune vidéo disponible.</p>';
                        }
                    })
                    .catch(error => console.error('Erreur lors du chargement des vidéos:', error));
            }

            // Function to load audio files
            function loadAudioFiles() {
                fetch('/api/settings/welcome-audio')
                    .then(response => response.json())
                    .then(data => {
                        const container = document.getElementById('currentAudio');
                        container.innerHTML = '';

                        if (data.audio && data.audio.length > 0) {
                            data.audio.forEach(audio => {
                                const audioDiv = document.createElement('div');
                                audioDiv.className = 'audio-item';
                                
                                // Create audio preview with controls
                                const audioElement = document.createElement('audio');
                                audioElement.className = 'play-preview';
                                audioElement.src = `/media/audio/${audio}`;
                                audioElement.controls = true;
                                
                                // Create title
                                const title = document.createElement('div');
                                title.className = 'media-title';
                                title.textContent = audio;
                                
                                // Create info box
                                const infoBox = document.createElement('div');
                                infoBox.className = 'audio-preview';
                                infoBox.innerHTML = `<i class="fas fa-music"></i> ${audio}`;
                                
                                // Delete button
                                const deleteBtn = document.createElement('button');
                                deleteBtn.className = 'btn btn-sm btn-danger mt-2';
                                deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Supprimer';
                                deleteBtn.onclick = function() {
                                    deleteMedia('audio', audio);
                                };
                                
                                audioDiv.appendChild(infoBox);
                                audioDiv.appendChild(audioElement);
                                audioDiv.appendChild(deleteBtn);
                                container.appendChild(audioDiv);
                            });
                        } else {
                            container.innerHTML = '<p>Aucun fichier audio disponible.</p>';
                        }
                    })
                    .catch(error => console.error('Erreur lors du chargement des fichiers audio:', error));
            }

            // Function to delete media (images, videos, audio)
            function deleteMedia(mediaType, filename) {
                if (confirm(`Voulez-vous vraiment supprimer ${mediaType === 'images' ? 'cette image' : mediaType === 'videos' ? 'cette vidéo' : 'ce fichier audio'} ?`)) {
                    fetch(`/api/settings/welcome-${mediaType}/${filename}`, {
                        method: 'DELETE'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            if (mediaType === 'images') {
                                loadImages();
                            } else if (mediaType === 'videos') {
                                loadVideos();
                            } else if (mediaType === 'audio') {
                                loadAudioFiles();
                            }
                        } else {
                            alert(`Erreur lors de la suppression du fichier ${mediaType}.`);
                        }
                    })
                    .catch(error => console.error('Erreur:', error));
                }
            }

            // Charger la liste des clients
            function loadClients() {
                fetch('/api/customers')
                    .then(response => response.json())
                    .then(data => {
                        const tbody = document.getElementById('clientsTable');
                        tbody.innerHTML = '';

                        if (data && data.length > 0) {
                            data.forEach(client => {
                                const row = document.createElement('tr');

                                const formatDate = (dateString) => {
                                    const date = new Date(dateString);
                                    return date.toLocaleString();
                                };

                                row.innerHTML = `
                                    <td>${client.phoneNumber}</td>
                                    <td>${client.name || 'Inconnu'}</td>
                                    <td>${formatDate(client.firstContactDate)}</td>
                                    <td>${formatDate(client.lastContactDate)}</td>
                                    <td>${client.messageCount}</td>
                                    <td>
                                        <button class="btn btn-sm btn-whatsapp" onclick="sendManualMessage('${client.phoneNumber}')">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                    </td>
                                `;

                                tbody.appendChild(row);
                            });
                        } else {
                            tbody.innerHTML = '<tr><td colspan="6" class="text-center">Aucun client disponible.</td></tr>';
                        }
                    })
                    .catch(error => console.error('Erreur lors du chargement des clients:', error));
            }

            // ===== PRODUCT MANAGEMENT FUNCTIONS =====
            
            // Global variables for product management
            let products = [];
            let categories = [];
            let currentProductId = null;
            let productImages = [];
            
            // Load products
            function loadProducts() {
                const productsList = document.getElementById('productsList');
                productsList.innerHTML = `
                    <div class="text-center py-5">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                        <p class="mt-2">Chargement des produits...</p>
                    </div>
                `;
                
                fetch('/api/products')
                    .then(response => response.json())
                    .then(data => {
                        products = data.products || [];
                        displayProducts(products);
                    })
                    .catch(error => {
                        console.error('Erreur lors du chargement des produits:', error);
                        productsList.innerHTML = `
                            <div class="alert alert-danger">
                                Erreur lors du chargement des produits. Veuillez réessayer.
                            </div>
                        `;
                    });
            }
            
            // Load categories
            function loadCategories() {
                fetch('/api/categories')
                    .then(response => response.json())
                    .then(data => {
                        categories = data || [];
                        updateCategoryFilters();
                        updateCategoryDropdown();
                    })
                    .catch(error => console.error('Erreur lors du chargement des catégories:', error));
            }
            
            // Update category filters in the dropdown
            function updateCategoryFilters() {
                const categoryFilter = document.getElementById('categoryFilter');
                
                // Keep the "All categories" option
                categoryFilter.innerHTML = `
                    <li><a class="dropdown-item active" href="#" data-category="all">Toutes les catégories</a></li>
                `;
                
                // Add categories
                if (categories.length > 0) {
                    categories.forEach(category => {
                        const li = document.createElement('li');
                        li.innerHTML = `<a class="dropdown-item" href="#" data-category="${category.name}">${category.name}</a>`;
                        categoryFilter.appendChild(li);
                    });
                }
                
                // Add event listeners
                const categoryLinks = categoryFilter.querySelectorAll('.dropdown-item');
                categoryLinks.forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        
                        // Remove active class from all links
                        categoryLinks.forEach(l => l.classList.remove('active'));
                        
                        // Add active class to clicked link
                        this.classList.add('active');
                        
                        // Filter products
                        const category = this.getAttribute('data-category');
                        filterProducts();
                    });
                });
            }
            
            // Update category dropdown in product form
            function updateCategoryDropdown() {
                const categorySelect = document.getElementById('productCategory');
                categorySelect.innerHTML = '<option value="">Sélectionner une catégorie</option>';
                
                if (categories.length > 0) {
                    categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.name;
                        option.textContent = category.name;
                        categorySelect.appendChild(option);
                    });
                }
            }
            
            // Display products in the list
            function displayProducts(productsToDisplay) {
                const productsList = document.getElementById('productsList');
                
                if (!productsToDisplay || productsToDisplay.length === 0) {
                    productsList.innerHTML = `
                        <div class="alert alert-info">
                            Aucun produit trouvé. Cliquez sur "Ajouter un Produit" pour créer votre premier produit.
                        </div>
                    `;
                    return;
                }
                
                productsList.innerHTML = '';
                
                productsToDisplay.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.className = 'product-card';
                    
                    const imgSrc = product.images && product.images.length > 0 
                        ? product.images[0] 
                        : 'https://via.placeholder.com/100x100?text=No+Image';
                    
                    productCard.innerHTML = `
                        <div class="product-header">
                            <div>
                                <strong>${product.name}</strong>
                                <span class="ms-2 text-muted">(${product.code})</span>
                            </div>
                            <span class="category-badge">${product.category || 'Non catégorisé'}</span>
                        </div>
                        <div class="product-body">
                            <div class="row">
                                <div class="col-md-2">
                                    <img src="${imgSrc}" alt="${product.name}" class="img-fluid rounded">
                                </div>
                                <div class="col-md-6">
                                    <p>${product.description || 'Aucune description'}</p>
                                    <div class="mt-2">
                                        ${renderAttributes(product.attributes)}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Prix:</span>
                                        <strong>${product.price} MAD</strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>Stock:</span>
                                        <span class="${product.inStock ? 'in-stock' : 'out-of-stock'}">
                                            ${product.inStock ? `En stock (${product.stockQuantity || 0})` : 'Épuisé'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="product-footer">
                            <small class="text-muted">Dernière mise à jour: ${formatDate(product.updatedAt)}</small>
                            <div>
                                <button class="btn btn-sm btn-outline-primary edit-product" data-id="${product._id}">
                                    <i class="fas fa-edit"></i> Modifier
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-product" data-id="${product._id}">
                                    <i class="fas fa-trash"></i> Supprimer
                                </button>
                            </div>
                        </div>
                    `;
                    
                    productsList.appendChild(productCard);
                });
                
                // Add event listeners to buttons
                document.querySelectorAll('.edit-product').forEach(button => {
                    button.addEventListener('click', function() {
                        const productId = this.getAttribute('data-id');
                        editProduct(productId);
                    });
                });
                
                document.querySelectorAll('.delete-product').forEach(button => {
                    button.addEventListener('click', function() {
                        const productId = this.getAttribute('data-id');
                        deleteProduct(productId);
                    });
                });
            }
            
            // Helper function to render product attributes
            function renderAttributes(attributes) {
                if (!attributes || Object.keys(attributes).length === 0) {
                    return '<p class="text-muted">Aucun attribut</p>';
                }
                
                let html = '';
                for (const [key, value] of Object.entries(attributes)) {
                    html += `
                        <div class="product-attribute">
                            <div class="attribute-key">${key}:</div>
                            <div class="attribute-value">${value}</div>
                        </div>
                    `;
                }
                return html;
            }
            
            // Format date helper
            function formatDate(dateString) {
                if (!dateString) return 'N/A';
                const date = new Date(dateString);
                return date.toLocaleString();
            }
            
            // Filter products based on search and category
            function filterProducts() {
                const searchTerm = document.getElementById('productSearch').value.toLowerCase();
                const categoryFilter = document.querySelector('#categoryFilter .dropdown-item.active');
                const category = categoryFilter ? categoryFilter.getAttribute('data-category') : 'all';
                
                let filtered = products;
                
                // Filter by search term
                if (searchTerm) {
                    filtered = filtered.filter(product => 
                        product.name.toLowerCase().includes(searchTerm) ||
                        product.code.toLowerCase().includes(searchTerm) ||
                        (product.description && product.description.toLowerCase().includes(searchTerm))
                    );
                }
                
                // Filter by category
                if (category !== 'all') {
                    filtered = filtered.filter(product => product.category === category);
                }
                
                displayProducts(filtered);
            }
            
            // Add event listener to search input
            document.getElementById('productSearch').addEventListener('input', filterProducts);
            
            // Initialize product modal
            const productModal = new bootstrap.Modal(document.getElementById('productModal'));
            
            // Show modal to add a new product
            document.getElementById('addProductBtn').addEventListener('click', function() {
                // Reset form
                document.getElementById('productModalLabel').textContent = 'Ajouter un Produit';
                document.getElementById('productCode').value = '';
                document.getElementById('productName').value = '';
                document.getElementById('productCategory').value = '';
                document.getElementById('productPrice').value = '0';
                document.getElementById('productInStock').checked = true;
                document.getElementById('productQuantity').value = '0';
                document.getElementById('productDescription').value = '';
                document.getElementById('productAttributes').innerHTML = '';
                document.getElementById('productImagesPreview').innerHTML = '';
                
                currentProductId = null;
                productImages = [];
                
                productModal.show();
            });
            
            // Add attribute button
            document.getElementById('addAttributeBtn').addEventListener('click', function() {
                addAttributeRow();
            });
            
            // Function to add an attribute row to the form
            function addAttributeRow(key = '', value = '') {
                const attributesContainer = document.getElementById('productAttributes');
                const attributeRow = document.createElement('div');
                attributeRow.className = 'row mb-2 attribute-row';
                
                attributeRow.innerHTML = `
                    <div class="col-5">
                        <input type="text" class="form-control attr-key" placeholder="Nom" value="${key}">
                    </div>
                    <div class="col-5">
                        <input type="text" class="form-control attr-value" placeholder="Valeur" value="${value}">
                    </div>
                    <div class="col-2">
                        <button type="button" class="btn btn-outline-danger remove-attr">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                
                // Add event listener to remove button
                attributeRow.querySelector('.remove-attr').addEventListener('click', function() {
                    attributeRow.remove();
                });
                
                attributesContainer.appendChild(attributeRow);
            }
            
            // Handle product image uploads
            document.getElementById('productImages').addEventListener('change', function(e) {
                const files = e.target.files;
                const previewContainer = document.getElementById('productImagesPreview');
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const imgDiv = document.createElement('div');
                        imgDiv.className = 'image-item';
                        
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'preview-image';
                        img.alt = file.name;
                        
                        const removeBtn = document.createElement('div');
                        removeBtn.className = 'remove-img';
                        removeBtn.innerHTML = '×';
                        removeBtn.onclick = function() {
                            imgDiv.remove();
                            
                            // Remove from productImages array
                            const index = productImages.findIndex(f => f.name === file.name);
                            if (index !== -1) {
                                productImages.splice(index, 1);
                            }
                        };
                        
                        imgDiv.appendChild(img);
                        imgDiv.appendChild(removeBtn);
                        previewContainer.appendChild(imgDiv);
                        
                        // Add to productImages array
                        productImages.push(file);
                    };
                    
                    reader.readAsDataURL(file);
                }
            });
            
            // Save product
            document.getElementById('saveProductBtn').addEventListener('click', function() {
                // Validate form
                const code = document.getElementById('productCode').value.trim();
                const name = document.getElementById('productName').value.trim();
                
                if (!code || !name) {
                    alert('Veuillez remplir tous les champs obligatoires (Code et Nom)');
                    return;
                }
                
                // Collect attributes
                const attributes = {};
                document.querySelectorAll('.attribute-row').forEach(row => {
                    const key = row.querySelector('.attr-key').value.trim();
                    const value = row.querySelector('.attr-value').value.trim();
                    
                    if (key && value) {
                        attributes[key] = value;
                    }
                });
                
                // Create FormData
                const formData = new FormData();
                formData.append('code', code);
                formData.append('name', name);
                formData.append('category', document.getElementById('productCategory').value);
                formData.append('price', document.getElementById('productPrice').value);
                formData.append('inStock', document.getElementById('productInStock').checked);
                formData.append('stockQuantity', document.getElementById('productQuantity').value);
                formData.append('description', document.getElementById('productDescription').value);
                formData.append('attributes', JSON.stringify(attributes));
                
                // Add images
                for (let i = 0; i < productImages.length; i++) {
                    formData.append('images', productImages[i]);
                }
                
                // Determine if updating or creating
                const url = currentProductId ? `/api/products/${currentProductId}` : '/api/products';
                const method = currentProductId ? 'PUT' : 'POST';
                
                fetch(url, {
                    method: method,
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success || data._id) {
                        alert(currentProductId ? 'Produit mis à jour avec succès!' : 'Produit ajouté avec succès!');
                        productModal.hide();
                        loadProducts();
                        
                        // Refresh AI data
                        refreshAIProductData();
                    } else {
                        alert('Erreur lors de l\'enregistrement du produit.');
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert('Erreur lors de l\'enregistrement du produit.');
                });
            });
            
            // Edit product
            function editProduct(productId) {
                const product = products.find(p => p._id === productId);
                if (!product) return;
                
                // Set form values
                document.getElementById('productModalLabel').textContent = 'Modifier le Produit';
                document.getElementById('productCode').value = product.code || '';
                document.getElementById('productName').value = product.name || '';
                document.getElementById('productCategory').value = product.category || '';
                document.getElementById('productPrice').value = product.price || 0;
                document.getElementById('productInStock').checked = product.inStock || false;
                document.getElementById('productQuantity').value = product.stockQuantity || 0;
                document.getElementById('productDescription').value = product.description || '';
                
                // Clear attributes and images
                document.getElementById('productAttributes').innerHTML = '';
                document.getElementById('productImagesPreview').innerHTML = '';
                
                // Add attributes
                if (product.attributes) {
                    for (const [key, value] of Object.entries(product.attributes)) {
                        addAttributeRow(key, value);
                    }
                }
                
                // Show images
                if (product.images && product.images.length > 0) {
                    const previewContainer = document.getElementById('productImagesPreview');
                    
                    product.images.forEach(image => {
                        const imgDiv = document.createElement('div');
                        imgDiv.className = 'image-item';
                        
                        const img = document.createElement('img');
                        img.src = image;
                        img.className = 'preview-image';
                        img.alt = 'Product image';
                        
                        imgDiv.appendChild(img);
                        previewContainer.appendChild(imgDiv);
                    });
                }
                
                currentProductId = productId;
                productImages = [];
                
                productModal.show();
            }
            
            // Delete product
            function deleteProduct(productId) {
                if (!confirm('Êtes-vous sûr de vouloir supprimer ce produit?')) return;
                
                fetch(`/api/products/${productId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success || data.message) {
                        alert('Produit supprimé avec succès!');
                        loadProducts();
                        
                        // Refresh AI data
                        refreshAIProductData();
                    } else {
                        alert('Erreur lors de la suppression du produit.');
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert('Erreur lors de la suppression du produit.');
                });
            }
            
            // Refresh AI Product Data
            function refreshAIProductData() {
                const btn = document.getElementById('refreshAIData');
                const originalText = btn.innerHTML;
                
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Actualisation...';
                btn.disabled = true;
                
                fetch('/api/ai/refresh-product-info', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Données des produits pour l\'IA actualisées avec succès!');
                    } else {
                        alert('Erreur lors de l\'actualisation des données pour l\'IA.');
                    }
                    
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert('Erreur lors de l\'actualisation des données pour l\'IA.');
                    
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
            }
            
            // Refresh AI Data button
            document.getElementById('refreshAIData').addEventListener('click', refreshAIProductData);

            // Envoyer un message manuel à un client
            window.sendManualMessage = function (phoneNumber) {
                // Create a modal for message options
                const modalHtml = `
                    <div class="modal fade" id="sendMessageModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Envoyer un message</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <ul class="nav nav-tabs" id="messageTypeTab" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="text-tab" data-bs-toggle="tab" 
                                                data-bs-target="#text-content" type="button" role="tab">Texte</button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="media-tab" data-bs-toggle="tab" 
                                                data-bs-target="#media-content" type="button" role="tab">Média</button>
                                        </li>
                                    </ul>
                                    <div class="tab-content mt-3" id="messageTypeTabContent">
                                        <div class="tab-pane fade show active" id="text-content" role="tabpanel">
                                            <div class="mb-3">
                                                <label for="textMessage" class="form-label">Message</label>
                                                <textarea class="form-control" id="textMessage" rows="4"></textarea>
                                            </div>
                                        </div>
                                        <div class="tab-pane fade" id="media-content" role="tabpanel">
                                            <div class="mb-3">
                                                <label for="mediaType" class="form-label">Type de média</label>
                                                <select class="form-select" id="mediaType">
                                                    <option value="images">Image</option>
                                                    <option value="videos">Vidéo</option>
                                                    <option value="audio">Audio</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label for="mediaFile" class="form-label">Fichier</label>
                                                <select class="form-select" id="mediaFile">
                                                    <option>Sélectionnez un type de média d'abord</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                                    <button type="button" class="btn btn-whatsapp" id="sendMessageBtn">Envoyer</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Append the modal to the document
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Initialize the modal
                const modal = new bootstrap.Modal(document.getElementById('sendMessageModal'));
                modal.show();
                
                // Handle media type change
                document.getElementById('mediaType').addEventListener('change', function() {
                    const mediaType = this.value;
                    const mediaFileSelect = document.getElementById('mediaFile');
                    
                    // Clear current options
                    mediaFileSelect.innerHTML = '';
                    
                    // Fetch files based on media type
                    fetch(`/api/settings/welcome-${mediaType}`)
                        .then(response => response.json())
                        .then(data => {
                            let files = [];
                            if (mediaType === 'images') files = data.images || [];
                            else if (mediaType === 'videos') files = data.videos || [];
                            else if (mediaType === 'audio') files = data.audio || [];
                            
                            if (files.length > 0) {
                                files.forEach(file => {
                                    const option = document.createElement('option');
                                    option.value = file;
                                    option.textContent = file;
                                    mediaFileSelect.appendChild(option);
                                });
                            } else {
                                const option = document.createElement('option');
                                option.textContent = `Aucun fichier ${mediaType} disponible`;
                                mediaFileSelect.appendChild(option);
                            }
                        })
                        .catch(error => console.error('Erreur:', error));
                });
                
                // Handle send button click
                document.getElementById('sendMessageBtn').addEventListener('click', function() {
                    const activeTab = document.querySelector('#messageTypeTab .nav-link.active').id;
                    
                    if (activeTab === 'text-tab') {
                        // Send text message
                        const message = document.getElementById('textMessage').value;
                        if (!message) {
                            alert('Veuillez entrer un message.');
                            return;
                        }
                        
                        fetch('/api/send-message', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ phoneNumber, message })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert('Message envoyé avec succès!');
                                modal.hide();
                                // Remove the modal from DOM after hiding
                                document.getElementById('sendMessageModal').remove();
                            } else {
                                alert('Erreur lors de l\'envoi du message.');
                            }
                        })
                        .catch(error => console.error('Erreur:', error));
                    } else {
                        // Send media message
                        const mediaType = document.getElementById('mediaType').value;
                        const filename = document.getElementById('mediaFile').value;
                        
                        if (!filename || filename.includes('Aucun fichier') || filename === 'Sélectionnez un type de média d\'abord') {
                            alert('Veuillez sélectionner un fichier valide.');
                            return;
                        }
                        
                        fetch('/api/send-multimedia', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ phoneNumber, mediaType, filename })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert('Média envoyé avec succès!');
                                modal.hide();
                                // Remove the modal from DOM after hiding
                                document.getElementById('sendMessageModal').remove();
                            } else {
                                alert('Erreur lors de l\'envoi du média.');
                            }
                        })
                        .catch(error => console.error('Erreur:', error));
                    }
                });
                
                // Cleanup when modal is hidden
                document.getElementById('sendMessageModal').addEventListener('hidden.bs.modal', function() {
                    this.remove();
                });
            };

            // Vérifier l'état de la connexion WhatsApp
            function checkConnectionStatus() {
                fetch('/api/whatsapp-status')
                    .then(response => response.json())
                    .then(data => {
                        const statusBadge = document.getElementById('connectionStatus');
                        const qrContainer = document.getElementById('qrContainer');
                        const qrHelp = document.getElementById('qrHelp');

                        if (data.connected) {
                            // Le client est connecté
                            statusBadge.className = 'badge bg-success status-badge';
                            statusBadge.textContent = 'Connecté';
                            qrContainer.innerHTML = `
                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle"></i> WhatsApp connecté avec succès!
                                </div>
                            `;
                            qrHelp.textContent = 'Votre bot WhatsApp est actif et prêt à répondre.';
                        } else if (data.qr) {
                            // Un QR code est disponible
                            statusBadge.className = 'badge bg-warning status-badge';
                            statusBadge.textContent = 'En attente de connexion';

                            // Vider le conteneur
                            qrContainer.innerHTML = '';

                            // Créer un nouvel élément pour le QR code
                            const qrcode = document.createElement('div');
                            qrcode.id = 'qrcode';
                            qrContainer.appendChild(qrcode);

                            // Générer le code QR à l'aide de la bibliothèque QRCode.js
                            try {
                                new QRCode(qrcode, {
                                    text: data.qr,
                                    width: 256,
                                    height: 256,
                                    colorDark: '#000000',
                                    colorLight: '#ffffff',
                                    correctLevel: QRCode.CorrectLevel.H
                                });
                                console.log("QR code généré avec succès dans l'interface");
                            } catch (error) {
                                console.error("Erreur lors de la génération du QR code:", error);
                                qrContainer.innerHTML = `
                                <div class="alert alert-danger">
                                    <i class="fas fa-exclamation-circle"></i> Erreur lors de la génération du QR code.
                                </div>
                                `;
                            }

                            qrHelp.textContent = 'Scannez le code QR avec votre application WhatsApp pour vous connecter.';
                        } else {
                            // WhatsApp est déconnecté et aucun QR code n'est disponible
                            statusBadge.className = 'badge bg-danger status-badge';
                            statusBadge.textContent = 'Déconnecté';
                            qrContainer.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-circle"></i> WhatsApp déconnecté.
                            </div>
                            `;
                            qrHelp.textContent = 'Cliquez sur "Actualiser le QR" pour obtenir un nouveau code.';
                        }
                    })
                    .catch(error => {
                        console.error('Erreur lors de la vérification du statut:', error);
                        const statusBadge = document.getElementById('connectionStatus');
                        statusBadge.className = 'badge bg-danger status-badge';
                        statusBadge.textContent = 'Erreur de connexion';
                    });
            }

            // Gérer le bouton d'aperçu du message
            document.getElementById('previewMessage').addEventListener('click', function () {
                const message = document.getElementById('welcomeMessage').value;
                const preview = document.getElementById('messagePreview');

                preview.textContent = message;
                preview.classList.remove('d-none');
            });

            // Gérer le bouton de sauvegarde du message
            document.getElementById('saveMessage').addEventListener('click', function () {
                const message = document.getElementById('welcomeMessage').value;

                fetch('/api/settings/welcome-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Message d\'accueil enregistré avec succès!');
                        } else {
                            alert('Erreur lors de l\'enregistrement du message.');
                        }
                    })
                    .catch(error => console.error('Erreur:', error));
            });

            // Gérer l'upload d'images
            document.getElementById('imageUpload').addEventListener('change', function (e) {
                const files = e.target.files;
                if (!files.length) return;

                const formData = new FormData();
                for (let i = 0; i < files.length; i++) {
                    formData.append('images', files[i]);
                }

                fetch('/api/settings/welcome-images', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Images téléchargées avec succès!');
                            loadImages();
                            this.value = ''; // Réinitialiser l'input file
                        } else {
                            alert('Erreur lors du téléchargement des images.');
                        }
                    })
                    .catch(error => console.error('Erreur:', error));
            });

            // Event listener for video upload
            document.getElementById('videoUpload').addEventListener('change', function(e) {
                const files = e.target.files;
                if (!files.length) return;

                const formData = new FormData();
                for (let i = 0; i < files.length; i++) {
                    formData.append('videos', files[i]);
                }

                fetch('/api/settings/welcome-videos', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Vidéos téléchargées avec succès!');
                        loadVideos();
                        this.value = ''; // Reset the input field
                    } else {
                        alert('Erreur lors du téléchargement des vidéos.');
                    }
                })
                .catch(error => console.error('Erreur:', error));
            });

            // Event listener for audio upload
            document.getElementById('audioUpload').addEventListener('change', function(e) {
                const files = e.target.files;
                if (!files.length) return;

                const formData = new FormData();
                for (let i = 0; i < files.length; i++) {
                    formData.append('audio', files[i]);
                }

                fetch('/api/settings/welcome-audio', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Fichiers audio téléchargés avec succès!');
                        loadAudioFiles();
                        this.value = ''; // Reset the input field
                    } else {
                        alert('Erreur lors du téléchargement des fichiers audio.');
                    }
                })
                .catch(error => console.error('Erreur:', error));
            });

            // Gérer le bouton de rafraîchissement du QR
            document.getElementById('refreshQr').addEventListener('click', function () {
                // Changer le texte du bouton pour indiquer que l'action est en cours
                const button = this;
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Actualisation...';
                button.disabled = true;

                fetch('/api/refresh-qr', {
                    method: 'POST'
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log("Réponse d'actualisation du QR:", data);

                        if (data.success) {
                            // Si le QR code a été rafraîchi avec succès
                            checkConnectionStatus(); // Vérifier immédiatement le statut

                            // Vérifier à nouveau après une seconde pour être sûr
                            setTimeout(checkConnectionStatus, 1000);
                        } else {
                            // En cas d'erreur
                            alert('Erreur lors du rafraîchissement du code QR: ' + data.message);
                        }

                        // Restaurer le bouton après l'action
                        button.innerHTML = originalText;
                        button.disabled = false;
                    })
                    .catch(error => {
                        console.error('Erreur:', error);
                        alert('Erreur lors du rafraîchissement du code QR. Veuillez réessayer.');

                        // Restaurer le bouton après l'erreur
                        button.innerHTML = originalText;
                        button.disabled = false;
                    });
            });

            // Gérer le bouton de sauvegarde des paramètres
            document.getElementById('saveSettings').addEventListener('click', function () {
                const enableAutoReply = document.getElementById('enableAutoReply').checked;
                const enableAI = document.getElementById('enableAI').checked;
                const delay = document.getElementById('delayInput').value;

                // First update WhatsApp settings
                fetch('/api/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ enableAutoReply, delay })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Now update AI settings
                        fetch('/api/settings/ai', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ enableAI })
                        })
                        .then(response => response.json())
                        .then(aiData => {
                            if (aiData.success) {
                                alert('Paramètres enregistrés avec succès!');
                            } else {
                                alert('Erreur lors de l\'enregistrement des paramètres AI.');
                            }
                        })
                        .catch(error => console.error('Erreur AI:', error));
                    } else {
                        alert('Erreur lors de l\'enregistrement des paramètres.');
                    }
                })
                .catch(error => console.error('Erreur:', error));
            });

            // Load AI settings
            function loadAISettings() {
                fetch('/api/settings/ai')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('enableAI').checked = data.enableAI;
                })
                .catch(error => console.error('Erreur lors du chargement des paramètres AI:', error));
            }

            // Charger initialement les données
            loadStats();
            loadImages();
            loadVideos();
            loadAudioFiles();
            loadClients();
            loadProducts();
            loadCategories();
            loadAISettings();
            checkConnectionStatus();

            // Rafraîchir les données périodiquement
            setInterval(loadStats, 30000); // 30 secondes
            setInterval(checkConnectionStatus, 5000); // 5 secondes
        });
    </script>
    <script>
        // ===== AI AGENT FUNCTIONS =====
let aiContextData = null;
let testHistory = [];

// Load AI context data
function loadAIContext() {
    fetch('/api/ai/context')
        .then(response => response.json())
        .then(data => {
            aiContextData = data;
            document.getElementById('aiContextName').value = data.name || 'Informations sur les produits';
            document.getElementById('aiContext').value = data.content || '';
        })
        .catch(error => {
            console.error('Erreur lors du chargement du contexte AI:', error);
            showStatusMessage('Erreur lors du chargement des informations produits.', 'danger');
        });
}

// Show status message
function showStatusMessage(message, type = 'success') {
    const statusDiv = document.getElementById('statusMessage');
    statusDiv.textContent = message;
    statusDiv.className = `alert alert-${type}`;
    statusDiv.classList.remove('d-none');
    
    // Hide after 5 seconds
    setTimeout(() => {
        statusDiv.classList.add('d-none');
    }, 5000);
}

// Save AI context
function saveAIContext() {
    const content = document.getElementById('aiContext').value.trim();
    const name = document.getElementById('aiContextName').value.trim();
    
    if (!content) {
        showStatusMessage('Veuillez entrer des informations produits.', 'warning');
        return;
    }
    
    fetch('/api/ai/context', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ content, name })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            aiContextData = data.context;
            showStatusMessage('Informations produits enregistrées avec succès!');
            toggleEditMode(false);
        } else {
            showStatusMessage('Erreur lors de l\'enregistrement des informations.', 'danger');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showStatusMessage('Erreur lors de l\'enregistrement des informations.', 'danger');
    });
}

// Toggle edit mode
function toggleEditMode(isEditing) {
    const context = document.getElementById('aiContext');
    const nameInput = document.getElementById('aiContextName');
    const editBtn = document.getElementById('editAIContext');
    const saveBtn = document.getElementById('saveAIContext');
    const cancelBtn = document.getElementById('cancelAIContext');
    
    if (isEditing) {
        context.removeAttribute('disabled');
        nameInput.removeAttribute('disabled');
        editBtn.classList.add('d-none');
        saveBtn.classList.remove('d-none');
        cancelBtn.classList.remove('d-none');
    } else {
        context.setAttribute('disabled', 'disabled');
        nameInput.setAttribute('disabled', 'disabled');
        editBtn.classList.remove('d-none');
        saveBtn.classList.add('d-none');
        cancelBtn.classList.add('d-none');
    }
}

// Test AI response
function testAI() {
    const question = document.getElementById('testQuestion').value.trim();
    
    if (!question) {
        showStatusMessage('Veuillez entrer une question.', 'warning');
        return;
    }
    
    // Show loading indicator
    const testButton = document.getElementById('testAIButton');
    const originalText = testButton.innerHTML;
    testButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Traitement...';
    testButton.disabled = true;
    
    fetch('/api/ai/test', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ question })
    })
    .then(response => response.json())
    .then(data => {
        // Restore button
        testButton.innerHTML = originalText;
        testButton.disabled = false;
        
        if (data.success) {
            const responseContainer = document.getElementById('testResponseContainer');
            const response = document.getElementById('testResponse');
            
            responseContainer.classList.remove('d-none');
            response.textContent = data.response;
            
            // Add to history
            addToTestHistory(question, data.response);
        } else {
            showStatusMessage('Erreur lors du test de l\'IA: ' + (data.message || 'Erreur inconnue'), 'danger');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showStatusMessage('Erreur lors du test de l\'IA.', 'danger');
        
        // Restore button
        testButton.innerHTML = originalText;
        testButton.disabled = false;
    });
}

// Add to test history
function addToTestHistory(question, response) {
    // Add to array
    const timestamp = new Date();
    testHistory.unshift({ question, response, timestamp });
    
    // Keep only the 5 most recent tests
    if (testHistory.length > 5) {
        testHistory = testHistory.slice(0, 5);
    }
    
    // Update UI
    updateTestHistory();
}

// Update test history UI
function updateTestHistory() {
    const container = document.getElementById('testHistoryContainer');
    const historyDiv = document.getElementById('testHistory');
    
    if (testHistory.length === 0) {
        container.classList.add('d-none');
        return;
    }
    
    container.classList.remove('d-none');
    historyDiv.innerHTML = '';
    
    testHistory.forEach((item, index) => {
        const historyItem = document.createElement('div');
        historyItem.className = 'p-3 border-bottom';
        if (index === testHistory.length - 1) {
            historyItem.classList.remove('border-bottom');
        }
        
        const shortResponse = item.response.length > 100 
            ? item.response.substring(0, 100) + '...' 
            : item.response;
            
        historyItem.innerHTML = `
            <div class="fw-bold text-primary">Q: ${item.question}</div>
            <div class="mt-1">R: ${shortResponse}</div>
            <div class="text-muted small mt-1">${item.timestamp.toLocaleString()}</div>
        `;
        
        historyDiv.appendChild(historyItem);
    });
}

// Clear test history
function clearTestHistory() {
    testHistory = [];
    document.getElementById('testHistoryContainer').classList.add('d-none');
    document.getElementById('testResponseContainer').classList.add('d-none');
    document.getElementById('testQuestion').value = '';
}

// Add event listeners for AI Agent
document.addEventListener('DOMContentLoaded', function() {
    // Add these to your existing DOMContentLoaded handler
    
    // Load AI context when tab is shown
    document.getElementById('ai-agent-tab').addEventListener('shown.bs.tab', function() {
        loadAIContext();
    });
    
    // Edit button
    document.getElementById('editAIContext').addEventListener('click', function() {
        toggleEditMode(true);
    });
    
    // Save button
    document.getElementById('saveAIContext').addEventListener('click', function() {
        saveAIContext();
    });
    
    // Cancel button
    document.getElementById('cancelAIContext').addEventListener('click', function() {
        // Reset to original values
        document.getElementById('aiContextName').value = aiContextData?.name || 'Informations sur les produits';
        document.getElementById('aiContext').value = aiContextData?.content || '';
        toggleEditMode(false);
    });
    
    // Test button
    document.getElementById('testAIButton').addEventListener('click', function() {
        testAI();
    });
    
    // Enter key in test question input
    document.getElementById('testQuestion').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            testAI();
        }
    });
    
    // Clear history button
    document.getElementById('clearTestHistory').addEventListener('click', function() {
        clearTestHistory();
    });
});
    </script>
</body>

</html>